services:
  laravel:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    networks:
      - dokploy-network
    volumes:
      - laravel_storage:/var/www/html/storage
      - laravel_logs:/var/www/html/storage/logs
    environment:
      - APP_NAME=${APP_NAME:-LarastoryVPN}
      - APP_ENV=${APP_ENV:-production}
      - APP_KEY=${APP_KEY}
      - APP_DEBUG=${APP_DEBUG:-false}
      - APP_URL=${APP_URL:-https://larastory.com}
      - LOG_CHANNEL=stack
      - LOG_LEVEL=info
      - DB_CONNECTION=sqlite
      # 3x-ui Configuration
      - XUI_HOST=${XUI_HOST:-3x-ui}
      - XUI_PORT=${XUI_PORT:-2053}
      - XUI_PATH=${XUI_PATH:-}
      - XUI_USERNAME=${XUI_USERNAME}
      - XUI_PASSWORD=${XUI_PASSWORD}
      - XUI_INBOUND_ID=${XUI_INBOUND_ID:-1}
      # Telegram Configuration
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      # Domain Configuration (for quick switching)
      - VPN_PRIMARY_DOMAIN=${VPN_PRIMARY_DOMAIN:-larastory.com}
      - VPN_PANEL_DOMAIN=${VPN_PANEL_DOMAIN:-dashboard.larastory.com}
      - VPN_SUBSCRIPTION_PORT=${VPN_SUBSCRIPTION_PORT:-2096}
    # Domain managed via Dokploy UI: larastory.com → Port 80
    depends_on:
      - 3x-ui
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  3x-ui:
    image: ghcr.io/mhsanaei/3x-ui:latest
    restart: unless-stopped
    tty: true
    networks:
      - dokploy-network
    volumes:
      - xui_db:/etc/x-ui
      - xui_certs:/root/cert
    environment:
      - XRAY_VMESS_AEAD_FORCED=false
    ports:
      - "8443:8443"    # VPN connections (VLESS/Reality)
      - "2096:2096"    # Subscription port
    # Domain managed via Dokploy UI: dashboard.larastory.com → Port 2053
    # Note: No healthcheck - panel path is configurable in 3x-ui settings

volumes:
  laravel_storage:
  laravel_logs:
  xui_db:
  xui_certs:

networks:
  dokploy-network:
    external: true
